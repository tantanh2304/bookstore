{% extends "base.html" %}

{% block content %}
<div class="user-detail-header">
    <h2>üë§ Chi ti·∫øt t√†i kho·∫£n: {{ user.username }}</h2>
    <a href="{{ url_for('manage_users') }}" class="btn">‚Üê Quay l·∫°i</a>
</div>

<div class="user-info-container">
    <div class="user-info-card">
        <h3>Th√¥ng tin c√° nh√¢n</h3>
        <div class="info-row">
            <span class="label">ID:</span>
            <span class="value">{{ user.id }}</span>
        </div>
        <div class="info-row">
            <span class="label">T√™n ƒëƒÉng nh·∫≠p:</span>
            <span class="value">{{ user.username }}</span>
        </div>
        <div class="info-row">
            <span class="label">Email:</span>
            <span class="value">{{ user.email }}</span>
        </div>
        <div class="info-row">
            <span class="label">Quy·ªÅn:</span>
            <span class="value">
                {% if user.is_admin %}
                <span class="badge badge-admin">üëë Qu·∫£n tr·ªã vi√™n</span>
                {% else %}
                <span class="badge badge-user">üë§ Ng∆∞·ªùi d√πng</span>
                {% endif %}
            </span>
        </div>
        <div class="info-row">
            <span class="label">Ng√†y t·∫°o:</span>
            <span class="value">{{ user.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
        </div>
    </div>

    <div class="user-stats-card">
        <h3>Th·ªëng k√™</h3>
        <div class="stat-item">
            <div class="stat-number">{{ orders|length }}</div>
            <div class="stat-label">ƒê∆°n h√†ng</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ "{:,.0f}".format(total_spent) }} ƒë</div>
            <div class="stat-label">T·ªïng chi ti√™u</div>
        </div>
    </div>
</div>

{% if user.id != session.get('user_id') %}
<div class="admin-actions">
    <h3>H√†nh ƒë·ªông qu·∫£n tr·ªã</h3>
    
    <div class="action-buttons">
        <a href="{{ url_for('toggle_user_admin', user_id=user.id) }}" 
           class="btn btn-primary"
           onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën {% if user.is_admin %}g·ª° quy·ªÅn{% else %}c·∫•p quy·ªÅn{% endif %} admin?')">
            {% if user.is_admin %}
            üë§ G·ª° quy·ªÅn Admin
            {% else %}
            üëë C·∫•p quy·ªÅn Admin
            {% endif %}
        </a>
        
        <button class="btn btn-secondary" onclick="showResetPasswordModal()">
            üîë ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
        </button>
        
        <a href="{{ url_for('delete_user', user_id=user.id) }}" 
           class="btn btn-danger"
           onclick="return confirm('C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')">
            üóëÔ∏è X√≥a t√†i kho·∫£n
        </a>
    </div>
</div>
{% endif %}

<div class="orders-section">
    <h3>üì¶ L·ªãch s·ª≠ ƒë∆°n h√†ng ({{ orders|length }})</h3>
    
    {% if orders %}
    <div class="orders-table-container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>M√£ ƒë∆°n</th>
                    <th>Ng√†y ƒë·∫∑t</th>
                    <th>S·∫£n ph·∫©m</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="order-items">{{ order.items }}</td>
                    <td class="order-total">{{ "{:,.0f}".format(order.total) }} ƒë</td>
                    <td>
                        <span class="badge badge-{{ order.status }}">
                            {% if order.status == 'pending' %}
                            ‚è≥ ƒêang x·ª≠ l√Ω
                            {% elif order.status == 'completed' %}
                            ‚úÖ Ho√†n th√†nh
                            {% elif order.status == 'cancelled' %}
                            ‚ùå ƒê√£ h·ªßy
                            {% else %}
                            {{ order.status }}
                            {% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>üì≠ Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>
    </div>
    {% endif %}
</div>

<!-- Modal ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u -->
<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideResetPasswordModal()">&times;</span>
        <h3>üîë ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h3>
        <form method="POST" action="{{ url_for('reset_user_password', user_id=user.id) }}">
            <div class="form-group">
                <label for="new_password">M·∫≠t kh·∫©u m·ªõi:</label>
                <input type="password" id="new_password" name="new_password" 
                       class="form-control" required minlength="6"
                       placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)">
            </div>
            <div class="form-group">
                <label for="confirm_password">X√°c nh·∫≠n m·∫≠t kh·∫©u:</label>
                <input type="password" id="confirm_password" 
                       class="form-control" required minlength="6"
                       placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideResetPasswordModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
            </div>
        </form>
    </div>
</div>

<style>
.user-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.user-info-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.user-info-card, .user-stats-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.user-info-card h3, .user-stats-card h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
    font-size: 1.3em;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-row:last-child {
    border-bottom: none;
}

.info-row .label {
    font-weight: 600;
    color: #666;
}

.info-row .value {
    color: #333;
}

.badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}

.badge-admin {
    background: #ffd700;
    color: #333;
}

.badge-user {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-pending {
    background: #fff3cd;
    color: #856404;
}

.badge-completed {
    background: #d4edda;
    color: #155724;
}

.badge-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.user-stats-card {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stat-item {
    text-align: center;
    padding: 20px 0;
}

.stat-item:first-of-type {
    border-bottom: 2px solid #f0f0f0;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 1em;
}

.admin-actions {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.admin-actions h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.orders-section {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.orders-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.orders-table-container {
    overflow-x: auto;
}

.orders-table {
    width: 100%;
    border-collapse: collapse;
}

.orders-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
}

.orders-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.orders-table tr:hover {
    background: #f8f9fa;
}

.order-items {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.order-total {
    font-weight: 600;
    color: #4CAF50;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
    font-size: 1.1em;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: slideIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 20px;
}

.close:hover {
    color: #000;
}

.modal-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 5px rgba(76,175,80,0.3);
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 25px;
}

/* Button styles */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
}

.btn-primary {
    background: #4CAF50;
    color: white;
}

.btn-primary:hover {
    background: #45a049;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

/* Responsive */
@media (max-width: 768px) {
    .user-info-container {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
    
    .orders-table {
        font-size: 0.9em;
    }
    
    .order-items {
        max-width: 150px;
    }
}
</style>

<script>
function showResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'block';
}

function hideResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('resetPasswordModal');
    if (event.target == modal) {
        hideResetPasswordModal();
    }
}

// Validate m·∫≠t kh·∫©u kh·ªõp nhau
document.querySelector('form').addEventListener('submit', function(e) {
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    
    if (password !== confirm) {
        e.preventDefault();
        alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return false;
    }
});
</script>

{% endblock %}