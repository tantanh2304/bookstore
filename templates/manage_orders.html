{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manage_orders.css') }}">
{% endblock %}
{% block title %}Quản lý đơn hàng{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Quản lý đơn hàng</h1>
        <p class="text-gray-600">Xem và quản lý tất cả đơn hàng trong hệ thống</p>
    </div>

    <!-- Thống kê tổng quan -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-600">Tổng đơn hàng</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_orders }}</div>
        </div>
        <div class="bg-yellow-50 rounded-lg shadow p-4">
            <div class="text-sm text-yellow-700">Chờ xử lý</div>
            <div class="text-2xl font-bold text-yellow-800">{{ pending_orders }}</div>
        </div>
        <div class="bg-green-50 rounded-lg shadow p-4">
            <div class="text-sm text-green-700">Hoàn thành</div>
            <div class="text-2xl font-bold text-green-800">{{ completed_orders }}</div>
        </div>
        <div class="bg-red-50 rounded-lg shadow p-4">
            <div class="text-sm text-red-700">Đã hủy</div>
            <div class="text-2xl font-bold text-red-800">{{ cancelled_orders }}</div>
        </div>
        <div class="bg-blue-50 rounded-lg shadow p-4">
            <div class="text-sm text-blue-700">Doanh thu</div>
            <div class="text-2xl font-bold text-blue-800">{{ '{:,.0f}'.format(total_revenue) }}đ</div>
        </div>
    </div>

    <!-- Bộ lọc và tìm kiếm -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="GET" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-64">
                <input type="text" 
                       name="search" 
                       value="{{ search }}"
                       placeholder="Tìm theo ID hoặc tên người dùng..."
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <select name="status" 
                        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="this.form.submit()">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Tất cả trạng thái</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Chờ xử lý</option>
                    <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Đang xử lý</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Hoàn thành</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Đã hủy</option>
                </select>
            </div>
            <button type="submit" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Tìm kiếm
            </button>
            <a href="{{ url_for('export_orders', status=status_filter) }}" 
               class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                Xuất CSV
            </a>
        </form>
    </div>

    <!-- Bảng đơn hàng -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="table-white-header">
            <thead class="bg-gray-50" >
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sản phẩm</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đặt</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for order in orders %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#{{ order.id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ order.user.username }}</div>
                        <div class="text-sm text-gray-500">{{ order.user.email }}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        {{ order.items[:50] }}{% if order.items|length > 50 %}...{% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                        {{ '{:,.0f}'.format(order.total) }}đ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if order.status == 'pending' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                Chờ xử lý
                            </span>
                        {% elif order.status == 'processing' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                Đang xử lý
                            </span>
                        {% elif order.status == 'completed' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Hoàn thành
                            </span>
                        {% elif order.status == 'cancelled' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                Đã hủy
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" 
                           class="text-blue-600 hover:text-blue-900">
                            Chi tiết
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Phân trang -->
    {% if total_pages > 1 %}
    <div class="mt-6 flex justify-center">
        <nav class="flex space-x-2">
            {% if page > 1 %}
            <a href="{{ url_for('manage_orders', page=page-1, status=status_filter, search=search) }}" 
               class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
                Trước
            </a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">{{ p }}</span>
                {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                <a href="{{ url_for('manage_orders', page=p, status=status_filter, search=search) }}" 
                   class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
                    {{ p }}
                </a>
                {% elif p == page - 3 or p == page + 3 %}
                <span class="px-4 py-2">...</span>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
            <a href="{{ url_for('manage_orders', page=page+1, status=status_filter, search=search) }}" 
               class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
                Sau
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}