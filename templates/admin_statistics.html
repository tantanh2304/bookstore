{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_statistics.css') }}">
{% endblock %}
{% block title %}Th·ªëng k√™ & B√°o c√°o{% endblock %}

{% block content %}
<div class="statistics-container">
    <div class="stats-header">
        <h1><i class="fas fa-chart-line"></i> Th·ªëng k√™ & B√°o c√°o</h1>
        <p>T·ªïng quan v·ªÅ doanh thu v√† ho·∫°t ƒë·ªông kinh doanh</p>
    </div>

    <!-- B·ªô l·ªçc th·ªùi gian -->
    <div class="time-filter">
        <form method="GET" id="filterForm">
            <div class="filter-group">
                <label><i class="fas fa-calendar"></i> L·ªçc theo th·ªùi gian:</label>
                <select name="period" onchange="this.form.submit()">
                    <option value="7" {% if period == 7 %}selected{% endif %}>7 ng√†y qua</option>
                    <option value="30" {% if period == 30 %}selected{% endif %}>30 ng√†y qua</option>
                    <option value="90" {% if period == 90 %}selected{% endif %}>90 ng√†y qua</option>
                    <option value="365" {% if period == 365 %}selected{% endif %}>1 nƒÉm qua</option>
                    <option value="all" {% if period == 'all' %}selected{% endif %}>To√†n b·ªô</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="stats-grid">
        <div class="stat-card revenue">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-info">
                <h3>T·ªïng doanh thu</h3>
                <p class="stat-value">{{ '{:,.0f}'.format(total_revenue or 0) }}ƒë</p>
                <span class="stat-label">T·ª´ {{ completed_orders or 0 }} ƒë∆°n ho√†n th√†nh</span>
            </div>
        </div>

        <div class="stat-card orders">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-info">
                <h3>T·ªïng ƒë∆°n h√†ng</h3>
                <p class="stat-value">{{ total_orders or 0 }}</p>
                <span class="stat-label">ƒêang x·ª≠ l√Ω: {{ (pending_orders or 0) + (processing_orders or 0) }}</span>
            </div>
        </div>

        <div class="stat-card customers">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>Kh√°ch h√†ng</h3>
                <p class="stat-value">{{ total_users or 0 }}</p>
                <span class="stat-label">Admin: {{ admin_users or 0 }}</span>
            </div>
        </div>

        <div class="stat-card books">
            <div class="stat-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-info">
                <h3>S√°ch trong kho</h3>
                <p class="stat-value">{{ total_books or 0 }}</p>
                <span class="stat-label">T·ªìn kho: {{ total_stock or 0 }} cu·ªën</span>
            </div>
        </div>

        <div class="stat-card average">
            <div class="stat-icon">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-info">
                <h3>Gi√° tr·ªã TB/ƒê∆°n</h3>
                <p class="stat-value">{{ '{:,.0f}'.format(average_order_value or 0) }}ƒë</p>
                <span class="stat-label">D·ª±a tr√™n ƒë∆°n ho√†n th√†nh</span>
            </div>
        </div>

        <div class="stat-card pending-revenue">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>DT ch·ªù x·ª≠ l√Ω</h3>
                <p class="stat-value">{{ '{:,.0f}'.format(pending_revenue or 0) }}ƒë</p>
                <span class="stat-label">T·ª´ {{ pending_orders or 0 }} ƒë∆°n</span>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì doanh thu theo th·ªùi gian -->
    <div class="chart-section">
        <h2><i class="fas fa-chart-area"></i> Doanh thu theo th·ªùi gian</h2>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì tr·∫°ng th√°i ƒë∆°n h√†ng -->
    <div class="charts-row">
        <div class="chart-section half">
            <h2><i class="fas fa-chart-pie"></i> Ph√¢n b·ªë tr·∫°ng th√°i ƒë∆°n h√†ng</h2>
            <div class="chart-container">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>

        <div class="chart-section half">
            <h2><i class="fas fa-chart-bar"></i> Doanh thu theo tr·∫°ng th√°i</h2>
            <div class="chart-container">
                <canvas id="revenueByStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top kh√°ch h√†ng -->
    <div class="table-section">
        <h2><i class="fas fa-crown"></i> Top 10 Kh√°ch h√†ng VIP</h2>
        <div class="table-responsive">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n kh√°ch h√†ng</th>
                        <th>Email</th>
                        <th>S·ªë ƒë∆°n h√†ng</th>
                        <th>T·ªïng chi ti√™u</th>
                        <th>TB/ƒê∆°n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in top_customers or [] %}
                    <tr>
                        <td>
                            {% if loop.index <= 3 %}
                                <span class="rank-badge rank-{{ loop.index }}">
                                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% else %}ü•â{% endif %}
                                </span>
                            {% else %}
                                <span class="rank-number">{{ loop.index }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ customer.username }}</strong></td>
                        <td>{{ customer.email }}</td>
                        <td><span class="badge badge-info">{{ customer.order_count }} ƒë∆°n</span></td>
                        <td><strong class="text-success">{{ '{:,.0f}'.format(customer.total_spent or 0) }}ƒë</strong></td>
                        <td>{{ '{:,.0f}'.format((customer.total_spent or 0) / (customer.order_count or 1)) }}ƒë</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Top s√°ch b√°n ch·∫°y -->
    <div class="table-section">
        <h2><i class="fas fa-fire"></i> Top 10 S√°ch b√°n ch·∫°y</h2>
        <div class="table-responsive">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n s√°ch</th>
                        <th>S·ªë l∆∞·ª£ng ƒë√£ b√°n</th>
                        <th>Ph·∫ßn trƒÉm</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_books_sold = total_books_sold or (top_books[0][1] if top_books else 1) %}
                    {% for book in top_books or [] %}
                    <tr>
                        <td>
                            {% if loop.index <= 3 %}
                                <span class="rank-badge rank-{{ loop.index }}">
                                    {% if loop.index == 1 %}üèÜ{% elif loop.index == 2 %}üéñÔ∏è{% else %}üèÖ{% endif %}
                                </span>
                            {% else %}
                                <span class="rank-number">{{ loop.index }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ book[0] }}</strong></td>
                        <td><span class="badge badge-warning">{{ book[1] }} cu·ªën</span></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (book[1] / (top_books[0][1] or 1) * 100) }}%"></div>
                                <span class="progress-text">{{ '{:.1f}'.format(book[1] / (total_books_sold or 1) * 100) }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- N√∫t xu·∫•t b√°o c√°o -->
    <div class="export-section">
        <a href="{{ url_for('export_statistics', period=period or 'all') }}" class="btn-export">
            <i class="fas fa-file-excel"></i> Xu·∫•t b√°o c√°o Excel
        </a>
        <a href="{{ url_for('export_orders', status='all') }}" class="btn-export">
            <i class="fas fa-file-csv"></i> Xu·∫•t danh s√°ch ƒë∆°n h√†ng
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // D·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
    const revenueData = {{ (revenue_by_date or []) | tojson }};
    const orderStatusData = {
        pending: {{ pending_orders or 0 }},
        processing: {{ processing_orders or 0 }},
        completed: {{ completed_orders or 0 }},
        cancelled: {{ cancelled_orders or 0 }}
    };

    // Bi·ªÉu ƒë·ªì doanh thu theo th·ªùi gian
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: revenueData.map(item => item.date),
            datasets: [{
                label: 'Doanh thu (ƒë)',
                data: revenueData.map(item => item.revenue),
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Bi·ªÉu ƒë·ªì tr·∫°ng th√°i ƒë∆°n h√†ng (Pie)
    const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ch·ªù x·ª≠ l√Ω', 'ƒêang x·ª≠ l√Ω', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'],
            datasets: [{
                data: [
                    orderStatusData.pending,
                    orderStatusData.processing,
                    orderStatusData.completed,
                    orderStatusData.cancelled
                ],
                backgroundColor: ['#FFC107', '#2196F3', '#4CAF50', '#F44336']
            }]
        }
    });

    // Bi·ªÉu ƒë·ªì doanh thu theo tr·∫°ng th√°i
    const revenueStatusCtx = document.getElementById('revenueByStatusChart').getContext('2d');
    new Chart(revenueStatusCtx, {
        type: 'bar',
        data: {
            labels: ['Ch·ªù x·ª≠ l√Ω', 'ƒêang x·ª≠ l√Ω', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'],
            datasets: [{
                label: 'Doanh thu (ƒë)',
                data: [
                    {{ pending_revenue or 0 }},
                    {{ processing_revenue or 0 }},
                    {{ total_revenue or 0 }},
                    {{ cancelled_revenue or 0 }}
                ],
                backgroundColor: ['#FFC107', '#2196F3', '#4CAF50', '#F44336']
            }]
        }
    });
</script>
{% endblock %}
